#!/bin/bash
# DEBUG VERSION - Skips long installs and downloads to test Supervisor startup.

# --- Define Paths and Variables ---
PROJECT_PARENT_DIR="/root"
VISOMASTER_REPO_NAME="VisoMaster"
VISOMASTER_ROOT_DIR="$PROJECT_PARENT_DIR/$VISOMASTER_REPO_NAME"
VISOMASTER_REPO_URL="https://github.com/remphan1618/VisoMaster.git"
VENV_PATH="/opt/venv"
LOG_FILE="$PROJECT_PARENT_DIR/onstart_script_debug.log" # Use a different log name for debug

# --- Setup Logging & Execution ---
exec > >(tee -a "$LOG_FILE") 2> >(tee -a "$LOG_FILE" >&2)
echo "--- Starting DEBUG Provisioning Script $(date) ---"
echo "--- Logging to $LOG_FILE ---"
set -eux # Keep these for logging what runs

# --- Clone VisoMaster Repository (Still need the code structure) ---
if [ ! -d "$VISOMASTER_ROOT_DIR" ]; then
  echo "Cloning VisoMaster..."
  git clone "$VISOMASTER_REPO_URL" "$VISOMASTER_ROOT_DIR" || exit 1
  echo "Cloned."
else
  echo "VisoMaster directory exists, skipping clone."
fi

# --- Create Required Directories (Quick) ---
echo "Creating required directories..."
mkdir -p "$VISOMASTER_ROOT_DIR/Images" || exit 1
mkdir -p "$VISOMASTER_ROOT_DIR/Videos" || exit 1
mkdir -p "$VISOMASTER_ROOT_DIR/Output" || exit 1
echo "Directories created."

# --- Activate Python Virtual Environment (Still need this for context) ---
echo "Activating venv..."
if [ ! -f "$VENV_PATH/bin/activate" ]; then echo "ERROR: Venv activate script not found!" >&2; exit 1; fi
source "$VENV_PATH/bin/activate"
echo "Python: $(which python)"

# --- SKIPPED: Install TensorRT ---
echo "SKIPPING TensorRT install for debug."

# --- SKIPPED: Download VisoMaster Models ---
echo "SKIPPING Model downloads for debug."

# --- SKIPPED: Download and Overwrite Specific Inswapper Model ---
echo "SKIPPING Inswapper download for debug."

# --- Deactivate Virtual Environment (Optional) ---
# deactivate

echo "--- DEBUG Provisioning Script Finished $(date) ---"
# Container ENTRYPOINT (Supervisor) will run next.
