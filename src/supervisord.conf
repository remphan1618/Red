# /src/supervisord.conf
# Configuration file for Supervisor process manager
# Uses /VisoMaster for Jupyter directory and /logs for logs

[supervisord]
nodaemon=true       ; Run supervisor in the foreground (required for Docker)
user=root           ; Run supervisor itself as root
# *** Using /logs ***
logfile=/logs/supervisord.log ; Log supervisor messages itself
logfile_maxbytes=10MB
logfile_backups=3
pidfile=/tmp/supervisord.pid ; Default pid file location

[program:setup_environment]
command=/bin/bash -c "mkdir -p /workspace && cp /src/debian/icewm/wm_startup.sh /workspace/ && chmod +x /workspace/wm_startup.sh && mkdir -p /root/.vnc && touch /root/.Xauthority && chmod 600 /root/.Xauthority && xauth generate :1 . trusted || echo 'Failed to generate auth'"
autostart=true
autorestart=false
startretries=1
startsecs=0
priority=5                 ; Run first, before all other services
# *** Using /logs ***
stdout_logfile=/logs/setup_env.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
# *** Using /logs ***
stderr_logfile=/logs/setup_env_err.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
user=root

[program:jupyter]
# Run jupyter lab, listening on all interfaces (0.0.0.0), NO AUTHENTICATION (token/password = '')
command=jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password='' --NotebookApp.allow_origin='*' --NotebookApp.base_url=${JUPYTER_BASE_URL:-/}
# *** Using /VisoMaster ***
directory=/VisoMaster  ; Start Jupyter in the VisoMaster directory
autostart=true              ; Start Jupyter automatically
autorestart=true            ; Restart Jupyter if it crashes
priority=20                 ; Start after setup
# *** Using /logs ***
stdout_logfile=/logs/jupyter.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
# *** Using /logs ***
stderr_logfile=/logs/jupyter_err.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
user=root                   ; Run Jupyter as root

[program:vnc]
# Runs the original VNC startup script from /dockerstartup/
command=/dockerstartup/vnc_startup.sh --wait
autostart=true              ; Start VNC automatically
autorestart=true            ; Restart VNC service if it crashes
priority=30                 ; Start after Jupyter
# *** Using /logs ***
stdout_logfile=/logs/vnc.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
# *** Using /logs ***
stderr_logfile=/logs/vnc_err.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
user=root                   ; Run VNC startup as root

[program:visomaster]
command=/bin/bash -c "cd /VisoMaster && ls -la && python3 main.py || echo 'VisoMaster files not found or main.py is missing'"
autostart=true
autorestart=true
startretries=3
startsecs=5
directory=/VisoMaster
environment=DISPLAY=:1,XAUTHORITY=/root/.Xauthority
# *** Using /logs ***
stdout_logfile=/logs/visomaster.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
# *** Using /logs ***
stderr_logfile=/logs/visomaster_err.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
user=root
